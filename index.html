<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>S·ªï Thu Chi Online</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (M·ªõi) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- SheetJS ƒë·ªÉ xu·∫•t Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-red {
            0%, 100% { background-color: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); }
            50% { background-color: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); }
        }
        .animate-pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f9fafb; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const FIXED_CATEGORIES = [
            "ƒÇn (S√°ng/Tr∆∞a/T·ªëi)", "ƒÇn v·∫∑t/N∆∞·ªõc ng·ªçt", "Wi-Fi & ƒêi·ªán", "C∆∞·ªõi h·ªèi & Ma chay", 
            "H·ªçc ph√≠ cho Con", "B·ªâm cho Con", "S·ªØa cho Con", "XƒÉng xe", 
            "R√°c th·∫£i sinh ho·∫°t", "Nhu Y·∫øu Ph·∫©m", "ƒê·ªì d√πng Y T·∫ø", 
            "Ti·ªÅn Ti·∫øt Ki·ªám", "Ti·ªÅn C√° Nh√¢n", "N·ª£", "Mua S·∫Øm"
        ];

        // --- ICONS ---
        const IconBase = ({ size = 24, className = "", children }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Wallet = (p) => <IconBase {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const TrendingDown = (p) => <IconBase {...p}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></IconBase>;
        const CalendarIcon = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const PieChart = (p) => <IconBase {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>;
        const Settings = (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Lightbulb = (p) => <IconBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconBase>;
        const Edit2 = (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const X = (p) => <IconBase {...p}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></IconBase>;
        const Cloud = (p) => <IconBase {...p}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.6-2.2-4.7-4.8-4.7-2.3 0-4.2 1.6-4.7 3.8C1.8 15.6 0 17.5 0 20c0 2.8 2.2 5 5 5h12.5c2.5 0 4.5-2 4.5-4.5S20 16 17.5 19Z"/></IconBase>;
        const CloudOff = (p) => <IconBase {...p}><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"/><line x1="1" x2="23" y1="1" y2="23"/></IconBase>;
        const FileSpreadsheet = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>;

        const CustomDatePicker = ({ value, onChange }) => {
            const displayDate = value ? value.split('-').reverse().join('/') : '';
            return (
                <div className="relative w-36">
                    <input type="date" value={value} onChange={onChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"/>
                    <div className="w-full p-3 bg-gray-50 border-none rounded-xl text-sm font-medium text-gray-500 flex items-center justify-between pointer-events-none"><span>{displayDate}</span><CalendarIcon size={14} className="ml-1 opacity-70"/></div>
                </div>
            );
        };

        const App = () => {
            const [incomes, setIncomes] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [viewDate, setViewDate] = useState(new Date());
            
            // Inputs
            const [incomeSource, setIncomeSource] = useState(''); const [incomeAmount, setIncomeAmount] = useState(''); const [incomeDate, setIncomeDate] = useState(new Date().toISOString().split('T')[0]);
            const [expenseCategory, setExpenseCategory] = useState(''); const [expenseAmount, setExpenseAmount] = useState(''); const [expenseDate, setExpenseDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('add');
            
            // Edit/Filter State
            const [editingId, setEditingId] = useState(null); const [editingType, setEditingType] = useState(null);
            const [searchTerm, setSearchTerm] = useState(''); const [filterCategory, setFilterCategory] = useState('all');
            
            // System State
            const [showReloadConfirm, setShowReloadConfirm] = useState(false);
            const [suggestion, setSuggestion] = useState(0);
            
            // --- FIREBASE STATE ---
            const [firebaseConfigStr, setFirebaseConfigStr] = useState(() => localStorage.getItem('fb_config') || '');
            const [familyCode, setFamilyCode] = useState(() => localStorage.getItem('fb_family_code') || '');
            const [isConnected, setIsConnected] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const dbRef = useRef(null);

            // 1. Kh·ªüi t·∫°o Firebase v√† L·∫Øng nghe d·ªØ li·ªáu
            useEffect(() => {
                if (firebaseConfigStr && familyCode) {
                    try {
                        const config = JSON.parse(firebaseConfigStr);
                        if (!firebase.apps.length) { firebase.initializeApp(config); }
                        const db = firebase.firestore();
                        dbRef.current = db;
                        setIsConnected(true);
                        setIsSyncing(true);

                        // L·∫Øng nghe realtime
                        const unsubscribe = db.collection('families').doc(familyCode).onSnapshot((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                setIncomes(data.incomes || []);
                                setExpenses(data.expenses || []);
                            } else {
                                // N·∫øu ch∆∞a c√≥ tr√™n m√¢y th√¨ l·∫•y t·ª´ local l√™n
                                const localIncomes = JSON.parse(localStorage.getItem('family_incomes') || '[]');
                                const localExpenses = JSON.parse(localStorage.getItem('family_expenses') || '[]');
                                if (localIncomes.length > 0 || localExpenses.length > 0) {
                                    db.collection('families').doc(familyCode).set({ incomes: localIncomes, expenses: localExpenses });
                                }
                            }
                            setIsSyncing(false);
                        }, (error) => {
                            console.error("L·ªói sync:", error);
                            setIsConnected(false);
                            alert("L·ªói k·∫øt n·ªëi! Ki·ªÉm tra l·∫°i C·∫•u h√¨nh ho·∫∑c M·∫°ng.");
                        });
                        return () => unsubscribe();
                    } catch (e) { console.error(e); setIsConnected(false); }
                } else {
                    // Ch·∫ø ƒë·ªô Offline: Load t·ª´ LocalStorage
                    setIncomes(JSON.parse(localStorage.getItem('family_incomes') || '[]'));
                    setExpenses(JSON.parse(localStorage.getItem('family_expenses') || '[]'));
                }
            }, [firebaseConfigStr, familyCode]);

            // 2. L∆∞u d·ªØ li·ªáu (H√†m chung cho c·∫£ Online v√† Offline)
            const saveData = (newIncomes, newExpenses) => {
                setIncomes(newIncomes);
                setExpenses(newExpenses);
                
                // Lu√¥n l∆∞u local ƒë·ªÉ backup
                localStorage.setItem('family_incomes', JSON.stringify(newIncomes));
                localStorage.setItem('family_expenses', JSON.stringify(newExpenses));

                // N·∫øu c√≥ m·∫°ng th√¨ ƒë·∫©y l√™n m√¢y
                if (isConnected && dbRef.current && familyCode) {
                    setIsSyncing(true);
                    dbRef.current.collection('families').doc(familyCode).set({
                        incomes: newIncomes,
                        expenses: newExpenses
                    }).then(() => setIsSyncing(false)).catch(() => {
                        setIsSyncing(false);
                        alert("M·∫•t k·∫øt n·ªëi! D·ªØ li·ªáu ƒë√£ l∆∞u t·∫°m ·ªü m√°y.");
                    });
                }
            };

            // --- SMART SUGGESTION ---
            useEffect(() => {
                if (!expenseCategory) { setSuggestion(0); return; }
                let history = expenses.filter(e => e.category === expenseCategory);
                if (history.length > 0) {
                    history.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const recentHistory = history.slice(0, 10);
                    const total = recentHistory.reduce((sum, item) => sum + item.amount, 0);
                    setSuggestion(Math.round(total / recentHistory.length));
                } else { setSuggestion(0); }
            }, [expenseCategory, expenses]);

            const availableFilterCategories = useMemo(() => {
                const historyCategories = expenses.map(e => e.category);
                return Array.from(new Set([...FIXED_CATEGORIES, ...historyCategories])).sort();
            }, [expenses]);

            const getFiscalRange = (date) => {
                const year = date.getFullYear(), month = date.getMonth();
                const startDate = new Date(year, month, 0); startDate.setHours(0,0,0,0);
                const endDate = new Date(year, month, new Date(year, month + 1, 0).getDate() - 1); endDate.setHours(23,59,59,999);
                return { startDate, endDate };
            };
            const { startDate, endDate } = useMemo(() => getFiscalRange(viewDate), [viewDate]);

            const { filteredIncomes, filteredExpenses } = useMemo(() => {
                const filter = (items, type) => items.filter(item => {
                    const d = new Date(item.date);
                    if (!(d >= startDate && d <= endDate)) return false;
                    const searchLower = searchTerm.toLowerCase();
                    const itemText = (type === 'income' ? item.source : item.category).toLowerCase();
                    const itemAmount = item.amount.toString();
                    const matchesSearch = searchTerm === '' || itemText.includes(searchLower) || itemAmount.includes(searchLower);
                    const matchesCategory = filterCategory === 'all' || (type === 'expense' && item.category === filterCategory) || (type === 'income' && filterCategory === 'income_type');
                    return matchesSearch && matchesCategory;
                });
                return { filteredIncomes: filter(incomes, 'income'), filteredExpenses: filter(expenses, 'expense') };
            }, [incomes, expenses, startDate, endDate, searchTerm, filterCategory]);

            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN').format(amount);
            const formatDate = (date) => { if(!date) return ''; const d = new Date(date); return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`; };
            const handleAmountInput = (val, setter) => { const raw = val.replace(/\D/g,''); setter(raw === '' ? '' : Number(raw).toLocaleString('vi-VN')); };
            const parseAmount = (val) => val ? parseInt(val.replace(/\./g,''), 10) : 0;

            const handleAddIncome = () => {
                const amt = parseAmount(incomeAmount); if(!incomeSource || amt <= 0) return;
                const newItem = { id: editingId || Date.now(), source: incomeSource, amount: amt, date: new Date(incomeDate).toISOString() };
                const newIncomes = editingId && editingType === 'income' ? incomes.map(i => i.id === editingId ? newItem : i) : [newItem, ...incomes];
                saveData(newIncomes, expenses);
                if(editingId) alert('ƒê√£ c·∫≠p nh·∫≠t!');
                resetForm();
            };
            const handleAddExpense = () => {
                const amt = parseAmount(expenseAmount); if(!expenseCategory || amt <= 0) return;
                const newItem = { id: editingId || Date.now(), category: expenseCategory, amount: amt, date: new Date(expenseDate).toISOString() };
                const newExpenses = editingId && editingType === 'expense' ? expenses.map(e => e.id === editingId ? newItem : e) : [newItem, ...expenses];
                saveData(incomes, newExpenses);
                if(editingId) alert('ƒê√£ c·∫≠p nh·∫≠t!');
                resetForm();
            };
            const resetForm = () => { setIncomeSource(''); setIncomeAmount(''); setEditingId(null); setEditingType(null); setExpenseCategory(''); setExpenseAmount(''); };
            const handleEdit = (item, type) => {
                setEditingId(item.id); setEditingType(type); setActiveTab('add');
                if (type === 'income') { setIncomeSource(item.source); setIncomeAmount(Number(item.amount).toLocaleString('vi-VN')); setIncomeDate(item.date.split('T')[0]); } 
                else { setExpenseCategory(item.category); setExpenseAmount(Number(item.amount).toLocaleString('vi-VN')); setExpenseDate(item.date.split('T')[0]); }
            };
            const deleteItem = (id, type) => { if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')) { 
                const newIncomes = type === 'income' ? incomes.filter(i => i.id !== id) : incomes;
                const newExpenses = type === 'expense' ? expenses.filter(e => e.id !== id) : expenses;
                saveData(newIncomes, newExpenses);
            }};
            const applySuggestion = () => { setExpenseAmount(suggestion.toLocaleString('vi-VN')); };

            // --- EXPORT EXCEL ---
            const handleExportExcel = () => {
                const data = [
                    ...incomes.map(i => ({ Lo·∫°i: 'Thu', M·ª•c: i.source, 'S·ªë ti·ªÅn': i.amount, Ng√†y: formatDate(i.date) })),
                    ...expenses.map(e => ({ Lo·∫°i: 'Chi', M·ª•c: e.category, 'S·ªë ti·ªÅn': e.amount, Ng√†y: formatDate(e.date) }))
                ];
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ThuChi");
                XLSX.writeFile(wb, `Sothuchi_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            // --- HANDLE FIREBASE CONFIG ---
            const handleSaveConfig = () => {
                localStorage.setItem('fb_config', firebaseConfigStr);
                localStorage.setItem('fb_family_code', familyCode);
                window.location.reload();
            };
            const handleDisconnect = () => {
                if(confirm('B·∫°n mu·ªën ng·∫Øt k·∫øt n·ªëi? D·ªØ li·ªáu tr√™n m√°y s·∫Ω gi·ªØ nguy√™n, nh∆∞ng s·∫Ω kh√¥ng ƒë·ªìng b·ªô n·ªØa.')) {
                    localStorage.removeItem('fb_config');
                    localStorage.removeItem('fb_family_code');
                    window.location.reload();
                }
            };

            const sumIncomeMonth = incomes.filter(i => { const d = new Date(i.date); return d >= startDate && d <= endDate; }).reduce((a,c)=>a+c.amount,0);
            const sumExpenseMonth = expenses.filter(i => { const d = new Date(i.date); return d >= startDate && d <= endDate; }).reduce((a,c)=>a+c.amount,0);
            const balance = sumIncomeMonth - sumExpenseMonth;
            const isOverBudget = sumIncomeMonth > 0 && (sumExpenseMonth / sumIncomeMonth) > 0.9;

            return (
                <div className="min-h-screen pb-24 md:pb-0 relative font-sans">
                    <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative">
                        {isOverBudget && <div className="bg-red-50 text-red-600 px-4 py-2 text-xs font-bold flex items-center justify-center gap-2 animate-pulse-red border-b border-red-100"><AlertTriangle size={16} /> C·∫¢NH B√ÅO: ƒê√£ chi ti√™u qu√° 90% thu nh·∫≠p!</div>}
                        
                        <div className={`bg-gradient-to-r ${isConnected ? 'from-blue-800 to-indigo-900' : 'from-slate-700 to-gray-800'} p-6 pb-8 text-white rounded-b-3xl shadow-lg transition-colors duration-500`}>
                            <div className="flex items-center justify-between mb-4">
                                <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 15))} className="p-2 text-white/70 hover:text-white"><ChevronLeft size={24}/></button>
                                <div className="text-center">
                                    <span className="text-[10px] font-medium text-white/60 block mb-0.5 tracking-wider">{formatDate(startDate)} - {formatDate(endDate)}</span>
                                    <div className="font-bold text-xl text-white flex items-center gap-2 justify-center uppercase tracking-wide"><CalendarIcon size={18} className="text-blue-200"/> Th√°ng {viewDate.getMonth() + 1}/{viewDate.getFullYear()}</div>
                                </div>
                                <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 15))} className="p-2 text-white/70 hover:text-white"><ChevronRight size={24}/></button>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mt-2">
                                <div className="bg-green-500/20 backdrop-blur-sm p-4 rounded-2xl border border-green-500/30"><div className="flex items-center gap-1.5 text-green-300 text-xs font-bold uppercase mb-1"><TrendingUp size={14}/> T·ªïng thu</div><div className="font-bold text-lg text-green-50">{formatCurrency(sumIncomeMonth)} VNƒê</div></div>
                                <div className="bg-red-500/20 backdrop-blur-sm p-4 rounded-2xl border border-red-500/30"><div className="flex items-center gap-1.5 text-red-300 text-xs font-bold uppercase mb-1"><TrendingDown size={14}/> T·ªïng chi</div><div className="font-bold text-lg text-red-50">{formatCurrency(sumExpenseMonth)} VNƒê</div></div>
                            </div>
                            {/* Connection Status */}
                            <div className="absolute top-4 right-4">
                                {isConnected ? 
                                    <div className="flex items-center gap-1 text-[10px] bg-green-500/20 px-2 py-1 rounded-full border border-green-500/30 text-green-300">
                                        {isSyncing ? <div className="loader w-3 h-3 border-green-300 border-t-transparent"></div> : <Cloud size={12}/>} Online
                                    </div> : 
                                    <div className="flex items-center gap-1 text-[10px] bg-gray-500/40 px-2 py-1 rounded-full border border-gray-500/30 text-gray-300"><CloudOff size={12}/> Offline</div>
                                }
                            </div>
                        </div>

                        <div className="px-4 -mt-6 relative z-10">
                            <div className="bg-white rounded-xl shadow-xl p-1.5 flex border border-gray-100">
                                {['add', 'report', 'history', 'settings'].map(tab => (
                                    <button key={tab} onClick={()=>{setActiveTab(tab); resetForm();}} className={`flex-1 py-2.5 rounded-lg text-xs font-bold uppercase tracking-wide transition-all flex justify-center ${activeTab === tab ? 'bg-slate-800 text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}>
                                        {tab === 'add' ? 'Nh·∫≠p' : tab === 'report' ? 'B√°o C√°o' : tab === 'history' ? 'L·ªãch S·ª≠' : <Settings size={16}/>}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-4 pb-32">
                            {activeTab === 'add' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                    {editingId && <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-xl text-sm flex items-center justify-between"><span className="font-bold flex items-center gap-2"><Edit2 size={16}/> ƒêang s·ª≠a {editingType==='income'?'thu nh·∫≠p':'chi ti√™u'}</span><button onClick={resetForm} className="bg-white p-1 rounded-full border border-yellow-300 text-yellow-600"><X size={14}/></button></div>}
                                    <div className={`bg-white border border-green-100 rounded-2xl p-4 shadow-sm relative overflow-hidden ${editingId && editingType === 'expense' ? 'opacity-50 pointer-events-none' : ''}`}>
                                        <div className="absolute top-0 left-0 w-1.5 h-full bg-green-500"></div><div className="flex items-center gap-2 text-green-700 font-bold mb-3"><TrendingUp size={18}/> 1. Thu Nh·∫≠p</div>
                                        <div className="space-y-3 pl-2">
                                            <input type="text" placeholder="L∆∞∆°ng th√°ng..." value={incomeSource} onChange={e=>setIncomeSource(e.target.value)} className="w-full p-3 bg-gray-50 border-none rounded-xl font-medium"/>
                                            <div className="flex gap-2"><input type="text" inputMode="numeric" placeholder="0" value={incomeAmount} onChange={e=>handleAmountInput(e.target.value, setIncomeAmount)} className="flex-1 p-3 bg-gray-50 border-none rounded-xl font-bold text-gray-700 text-lg"/><CustomDatePicker value={incomeDate} onChange={e=>setIncomeDate(e.target.value)} /></div>
                                            <button onClick={handleAddIncome} disabled={!incomeSource || !incomeAmount} className="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-200 flex justify-center items-center gap-2">{editingId && editingType === 'income' ? 'C·∫≠p Nh·∫≠t' : <><Plus size={18}/> Th√™m</>}</button>
                                        </div>
                                    </div>
                                    <div className={`bg-white border border-red-100 rounded-2xl p-4 shadow-sm relative overflow-hidden ${editingId && editingType === 'income' ? 'opacity-50 pointer-events-none' : ''}`}>
                                        <div className="absolute top-0 left-0 w-1.5 h-full bg-red-500"></div><div className="flex items-center gap-2 text-red-700 font-bold mb-3"><TrendingDown size={18}/> 2. Chi Ti√™u</div>
                                        <div className="space-y-4 pl-2">
                                            <div><label className="text-xs text-gray-400 font-bold uppercase mb-2 block">Ch·ªçn m·ª•c chi:</label><div className="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto pr-1">{FIXED_CATEGORIES.map(cat => <button key={cat} onClick={()=>setExpenseCategory(cat)} className={`p-2 text-[10px] font-bold rounded-lg border transition-all truncate ${expenseCategory === cat ? 'bg-red-600 text-white border-red-600 shadow-md ring-2 ring-red-100' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>{cat}</button>)}</div></div>
                                            {suggestion > 0 && !editingId && <div onClick={applySuggestion} className="bg-blue-50 border border-blue-200 text-blue-700 px-3 py-2 rounded-lg text-xs flex items-center gap-2 cursor-pointer hover:bg-blue-100 animate-fadeIn"><Lightbulb size={14} className="text-yellow-500 fill-yellow-500"/><span>Trung b√¨nh g·∫ßn ƒë√¢y: <strong>{formatCurrency(suggestion)} VNƒê</strong></span><span className="ml-auto text-[10px] bg-blue-200 px-2 py-0.5 rounded text-blue-800 font-bold">D√πng lu√¥n</span></div>}
                                            <div className="flex gap-2 pt-2 border-t border-gray-100"><input type="text" inputMode="numeric" placeholder="S·ªë ti·ªÅn..." value={expenseAmount} onChange={e=>handleAmountInput(e.target.value, setExpenseAmount)} className="flex-1 p-3 bg-gray-50 border-none rounded-xl font-bold text-gray-700 text-lg"/><CustomDatePicker value={expenseDate} onChange={e=>setExpenseDate(e.target.value)} /></div>
                                            <button onClick={handleAddExpense} disabled={!expenseCategory || !expenseAmount} className="w-full py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-200 flex justify-center items-center gap-2">{editingId && editingType === 'expense' ? 'C·∫≠p Nh·∫≠t' : <><Save size={18}/> L∆∞u Chi</>}</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'report' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                        <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 border-b pb-2"><PieChart className="text-slate-600" size={20}/> T·ª∑ l·ªá chi ti√™u / Thu nh·∫≠p</h3>
                                        {filteredExpenses.length === 0 ? <div className="text-center py-10 text-gray-400 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu k·ª≥ n√†y</div> : 
                                            <div className="space-y-5">
                                                {Object.entries(filteredExpenses.reduce((a,c)=>{a[c.category]=(a[c.category]||0)+c.amount;return a},{})).sort(([,a],[,b])=>b-a).map(([cat,amt]) => {
                                                    const pct = sumIncomeMonth > 0 ? Math.round((amt/sumIncomeMonth)*100) : 0;
                                                    return (
                                                        <div key={cat} className="group">
                                                            <div className="flex justify-between text-sm mb-1.5"><span className="font-bold text-gray-700 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-500"></div> {cat}</span><span className="text-gray-900 font-bold">{formatCurrency(amt)} VNƒê</span></div>
                                                            <div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden"><div className="bg-red-500 h-full rounded-full transition-all duration-1000" style={{width: `${Math.min(pct,100)}%`}}></div></div>
                                                            <div className="text-right mt-1 text-[10px] text-gray-400 font-medium">Chi·∫øm {pct}% thu nh·∫≠p</div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        }
                                    </div>
                                </div>
                            )}

                            {activeTab === 'history' && (
                                <div className="animate-fadeIn mt-2">
                                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[50vh]">
                                        <div className="p-4 bg-gray-50 border-b border-gray-100">
                                            <div className="flex justify-between items-center mb-3">
                                                <h3 className="font-bold text-gray-700 text-sm flex items-center gap-2"><History size={16}/> L·ªãch s·ª≠ & T√¨m ki·∫øm</h3>
                                                <span className="text-[10px] bg-white border px-2 py-1 rounded text-gray-500 font-medium">{filteredIncomes.length + filteredExpenses.length} b·∫£n ghi</span>
                                            </div>
                                            <div className="flex gap-2">
                                                <div className="relative flex-1"><Search size={14} className="absolute left-3 top-3 text-gray-400" /><input type="text" placeholder="Nh·∫≠p Thu/Chi mu·ªën t√¨m..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-3 py-2.5 bg-white border border-gray-200 rounded-xl text-xs font-medium focus:ring-2 focus:ring-blue-100 outline-none"/></div>
                                                <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)} className="pl-2 pr-6 py-2 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-600 outline-none truncate max-w-[100px]"><option value="all">T·∫•t c·∫£</option><option value="income_type">Thu nh·∫≠p</option>{availableFilterCategories.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                            </div>
                                        </div>
                                        <div className="max-h-[60vh] overflow-y-auto">
                                            {[...filteredIncomes.map(i=>({...i,type:'income'})), ...filteredExpenses.map(e=>({...e,type:'expense'}))].sort((a,b)=>new Date(b.date)-new Date(a.date)).map((item,idx) => (
                                                <div key={item.id} className={`p-4 flex justify-between items-center hover:bg-gray-50 transition-colors ${idx!==0?'border-t border-gray-50':''}`}>
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 shadow-sm ${item.type==='income'?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}`}>{item.type==='income'?<TrendingUp size={18}/>:<TrendingDown size={18}/>}</div>
                                                        <div><p className="font-bold text-gray-800 text-sm">{item.type==='income'?item.source:item.category}</p><p className="text-xs text-gray-400 flex items-center gap-1 mt-0.5"><CalendarIcon size={10}/> {formatDate(item.date)}</p></div>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className={`font-bold text-sm ${item.type==='income'?'text-green-600':'text-red-600'}`}>{item.type==='income'?'+':'-'}{formatCurrency(item.amount)} VNƒê</p>
                                                        <div className="flex items-center justify-end gap-3 mt-1.5"><button onClick={()=>handleEdit(item, item.type)} className="text-[10px] text-gray-400 hover:text-blue-600 font-bold flex items-center gap-1"><Edit2 size={10}/> S·ª≠a</button><button onClick={()=>deleteItem(item.id, item.type)} className="text-[10px] text-gray-400 hover:text-red-500 font-bold flex items-center gap-1"><Trash2 size={10}/> X√≥a</button></div>
                                                    </div>
                                                </div>
                                            ))}
                                            {(filteredIncomes.length===0 && filteredExpenses.length===0) && <div className="p-10 text-center text-gray-400 text-sm">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                        <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 border-b pb-2"><Settings className="text-slate-600" size={20}/> C√†i ƒë·∫∑t & D·ªØ li·ªáu</h3>
                                        
                                        {/* CLOUD CONNECT SECTION */}
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                            <h4 className="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2"><Cloud size={16}/> 1. ƒê·ªìng b·ªô ƒê√°m m√¢y (Online)</h4>
                                            
                                            {isConnected ? (
                                                <div className="space-y-3">
                                                    <div className="bg-white p-3 rounded-lg border border-blue-200">
                                                        <p className="text-xs text-gray-500 uppercase font-bold">ƒêang k·∫øt n·ªëi t·ªõi:</p>
                                                        <p className="text-sm font-bold text-blue-600 mt-1">{familyCode}</p>
                                                    </div>
                                                    <button onClick={handleDisconnect} className="w-full py-2 bg-white text-red-500 border border-red-200 font-bold rounded-lg text-xs hover:bg-red-50">Ng·∫Øt k·∫øt n·ªëi</button>
                                                </div>
                                            ) : (
                                                <div className="space-y-3">
                                                    <p className="text-xs text-blue-600 leading-relaxed">Nh·∫≠p c·∫•u h√¨nh Firebase v√† M√£ gia ƒë√¨nh ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu gi·ªØa nhi·ªÅu m√°y.</p>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-gray-500 uppercase">M√£ Gia ƒê√¨nh (T·ª± t·∫°o, vd: NHA-TOI-123)</label>
                                                        <input type="text" value={familyCode} onChange={e=>setFamilyCode(e.target.value)} className="w-full p-2 mt-1 border rounded-lg text-sm bg-white" placeholder="V√≠ d·ª•: GD-123456" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-gray-500 uppercase">C·∫•u h√¨nh Firebase (JSON)</label>
                                                        <textarea value={firebaseConfigStr} onChange={e=>setFirebaseConfigStr(e.target.value)} className="w-full p-2 mt-1 border rounded-lg text-[10px] h-20 bg-white font-mono" placeholder='{"apiKey": "...", "authDomain": "..."}'></textarea>
                                                    </div>
                                                    <button onClick={handleSaveConfig} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-all text-xs">K·∫æT N·ªêI NGAY</button>
                                                </div>
                                            )}
                                        </div>

                                        {/* EXCEL EXPORT SECTION */}
                                        <div className="bg-green-50 p-4 rounded-xl border border-green-100">
                                            <h4 className="font-bold text-green-800 text-sm mb-1 flex items-center gap-2"><FileSpreadsheet size={16}/> 2. Xu·∫•t b√°o c√°o Excel</h4>
                                            <p className="text-xs text-green-600 mb-3">T·∫£i file Excel (.xlsx) ƒë·ªÉ xem tr√™n m√°y t√≠nh ho·∫∑c in ·∫•n.</p>
                                            <button onClick={handleExportExcel} className="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md flex justify-center items-center gap-2 transition-all text-xs"><Download size={16}/> T·∫£i file Excel</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div onClick={()=>setShowReloadConfirm(true)} className={`fixed bottom-8 right-4 z-50 flex flex-col items-center gap-1 cursor-pointer transition-all duration-300 ${balance===0?'opacity-80':'opacity-100'}`}>
                            <div className="bg-black/60 backdrop-blur-md text-white text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm border border-white/10">T·ªïng Ti·ªÅn C√≤n L·∫°i</div>
                            <div className={`shadow-2xl rounded-full px-5 py-3 flex items-center gap-3 border-2 border-white/20 backdrop-blur-lg transform hover:scale-105 active:scale-95 transition-all ${balance>=0?'bg-gradient-to-r from-blue-600 to-cyan-500':'bg-gradient-to-r from-red-600 to-orange-500'}`}>
                                <div className="bg-white/20 p-1.5 rounded-full"><Wallet size={20} className="text-white"/></div>
                                <div className="flex flex-col items-start"><span className="text-white font-extrabold text-lg leading-none">{formatCurrency(balance)} <span className="text-xs font-normal opacity-80">VNƒê</span></span></div>
                            </div>
                        </div>

                        {showReloadConfirm && (
                            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-fadeIn backdrop-blur-sm">
                                <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-xs w-full text-center border border-gray-100">
                                    <div className="bg-slate-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600"><RefreshCw size={24} /></div>
                                    <h3 className="font-bold text-lg text-slate-800 mb-2">T·∫£i l·∫°i ·ª©ng d·ª•ng?</h3>
                                    <div className="flex gap-3 mt-6"><button onClick={()=>setShowReloadConfirm(false)} className="flex-1 py-3 text-sm font-bold text-slate-500 bg-slate-100 rounded-xl">H·ªßy</button><button onClick={()=>window.location.reload()} className="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl shadow-lg">ƒê·ªìng √Ω</button></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

üìù H∆∞·ªõng d·∫´n L·∫•y "Ch√¨a kh√≥a" Firebase (L√†m 1 l·∫ßn duy nh·∫•t)
B·∫°n c·∫ßn th·ª±c hi·ªán b∆∞·ªõc n√†y tr√™n m√°y t√≠nh cho d·ªÖ, sau ƒë√≥ copy m√£ v√†o ƒëi·ªán tho·∫°i.
 * Truy c·∫≠p: console.firebase.google.com (ƒêƒÉng nh·∫≠p b·∫±ng Gmail).
 * B·∫•m "Create a project" (ho·∫∑c "Add project"). ƒê·∫∑t t√™n t√πy √Ω (v√≠ d·ª•: sothuchi), b·∫•m Continue -> T·∫Øt Google Analytics -> Create.
 * Khi t·∫°o xong, b·∫•m v√†o icon Web (</>) h√¨nh tr√≤n m√†u tr·∫Øng.
   * ƒê·∫∑t t√™n App: web -> B·∫•m Register app.
 * N√≥ s·∫Ω hi·ªán ra m·ªôt ƒëo·∫°n m√£. B·∫°n h√£y t√¨m v√† ch·ªâ copy ph·∫ßn trong ngo·∫∑c nh·ªçn { ... } gi·ªëng nh∆∞ n√†y:
   {
  "apiKey": "AIzaSyD...",
  "authDomain": "...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}




