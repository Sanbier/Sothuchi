<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Sổ Thu Chi & Quản Lý Nợ</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%232563eb'/%3E%3Cpath d='M384 192h-32v-32c0-35.3-28.7-64-64-64H112C76.7 96 48 124.7 48 160v192c0 35.3 28.7 64 64 64h224c35.3 0 64-28.7 64-64v-32h32c17.7 0 32-14.3 32-32v-64c0-17.7-14.3-32-32-32zm-64 192H112c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h176c17.7 0 32 14.3 32 32v192c0 17.7-14.3 32-32 32zm96-96h-32v-64h32v64z' fill='white'/%3E%3C/svg%3E">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-red {
            0%, 100% { background-color: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); }
            50% { background-color: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); }
        }
        .animate-pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        body { 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f9fafb;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-effect:active { transform: scale(0.95); }
        .input-effect:focus { transform: scale(1.01); border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .category-btn {
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            word-break: break-word;
            white-space: normal;
            padding: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const DEBT_CATEGORY_NAME = "Nợ (Vay - Trả Góp)";
        
        const SAVING_CATEGORIES = [
            "Tiết Kiệm Mục Tiêu", 
            "Tiết Kiệm Ngắn Hạn", 
            "Quỹ Khẩn Cấp"        
        ];

        const DEFAULT_CATEGORIES = [
            "Ăn (Sáng/Trưa/Tối)", "Ăn vặt/Nước ngọt", "Wi-Fi & Điện", "Cưới hỏi & Ma chay", 
            "Học phí cho Con", "Bỉm cho Con", "Sữa cho Con", "Xăng xe", 
            "Rác thải sinh hoạt", "Nhu Yếu Phẩm", "Đồ dùng Y Tế", 
            ...SAVING_CATEGORIES,
            "Tiền Cá Nhân", DEBT_CATEGORY_NAME, "Mua Sắm"
        ];

        const IconBase = ({ size = 24, className = "", children }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Wallet = (p) => <IconBase {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const TrendingDown = (p) => <IconBase {...p}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></IconBase>;
        const CalendarIcon = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const PieChart = (p) => <IconBase {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></IconBase>;
        const ChevronLeft = (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>;
        const Settings = (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Activity = (p) => <IconBase {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>;
        const Edit2 = (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const X = (p) => <IconBase {...p}><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></IconBase>;
        const Cloud = (p) => <IconBase {...p}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.6-2.2-4.7-4.8-4.7-2.3 0-4.2 1.6-4.7 3.8C1.8 15.6 0 17.5 0 20c0 2.8 2.2 5 5 5h12.5c2.5 0 4.5-2 4.5-4.5S20 16 17.5 19Z"/></IconBase>;
        const CloudOff = (p) => <IconBase {...p}><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"/><line x1="1" x2="23" y1="1" y2="23"/></IconBase>;
        const FileSpreadsheet = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>;
        const ChevronDown = (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>;
        const BookOpen = (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const CheckSquare = (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>;
        const PiggyBank = (p) => <IconBase {...p}><path d="M19 5c-1.5 0-2.8.6-3.5 1.5A5.6 5.6 0 0 0 12 5.5v.5h-.5a1.5 1.5 0 0 0 0 3h.5v.5a2 2 0 0 1-2 2 2 2 0 0 0-2-2h-2.5a2 2 0 0 0-2 2V13c0 2.5 4.5 4 4.5 4h1a5.5 5.5 0 0 0 5.5-5.5v-1a5.5 5.5 0 0 0 .8-2.5 1 1 0 0 0-1-1H19v-2Z"/><path d="M16 5.5a2.5 2.5 0 0 0-5 0V6h5v-.5Z"/><circle cx="16" cy="10" r="1"/></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const MessageCircle = (p) => <IconBase {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>;
        const Clock = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;

        const CustomDatePicker = ({ value, onChange, className="" }) => {
            const displayDate = value ? value.split('-').reverse().join('/') : '';
            return (
                <div className={`relative h-12 ${className}`}> 
                    <input type="date" value={value} onChange={onChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"/>
                    <div className="w-full h-full p-3 bg-gray-50 border-none rounded-xl text-sm font-medium text-gray-500 flex items-center justify-center pointer-events-none gap-2 input-effect transition-all duration-200"> 
                        <span>{displayDate}</span><CalendarIcon size={16} className="opacity-70"/>
                    </div>
                </div>
            );
        };

        const App = () => {
            const getLocalToday = () => {
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const [incomes, setIncomes] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [fixedTemplate, setFixedTemplate] = useState([]);
            const [categories, setCategories] = useState([]);
            const [debts, setDebts] = useState([]);
            const [fixedTracking, setFixedTracking] = useState({}); 
            
            const [viewDate, setViewDate] = useState(() => {
                const today = new Date();
                if (today.getDate() > 30) { today.setMonth(today.getMonth() + 1); today.setDate(1); }
                return today;
            });
            
            const [incomeSource, setIncomeSource] = useState(''); const [incomeAmount, setIncomeAmount] = useState(''); const [incomeDate, setIncomeDate] = useState(getLocalToday()); const [incomeNote, setIncomeNote] = useState('');
            
            const [expenseCategory, setExpenseCategory] = useState(''); const [expenseAmount, setExpenseAmount] = useState(''); const [expenseDate, setExpenseDate] = useState(getLocalToday()); const [expenseNote, setExpenseNote] = useState('');
            const [selectedDebtorId, setSelectedDebtorId] = useState('');
            
            const [activeTab, setActiveTab] = useState('add');
            
            const [editingId, setEditingId] = useState(null); const [editingType, setEditingType] = useState(null);
            const [searchTerm, setSearchTerm] = useState(''); const [filterCategory, setFilterCategory] = useState('all');
            
            const [showReloadConfirm, setShowReloadConfirm] = useState(false);
            const [categorySpent, setCategorySpent] = useState(0); 
            
            const [showFixedConfig, setShowFixedConfig] = useState(false);
            const [showFixedTrackingModal, setShowFixedTrackingModal] = useState(false); 
            const [tempFixedList, setTempFixedList] = useState({});
            const [fixedPaymentInputs, setFixedPaymentInputs] = useState({});

            const [firebaseConfigStr, setFirebaseConfigStr] = useState(() => localStorage.getItem('fb_config') || '');
            const [familyCode, setFamilyCode] = useState(() => localStorage.getItem('fb_family_code') || '');
            const [isConnected, setIsConnected] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [showCloudForm, setShowCloudForm] = useState(false);
            
            const [isCategoryManageMode, setIsCategoryManageMode] = useState(false);

            // Debt State
            const [debtName, setDebtName] = useState('');
            const [debtTotal, setDebtTotal] = useState('');
            const [debtPaid, setDebtPaid] = useState('');
            const [debtNote, setDebtNote] = useState('');
            const [debtType, setDebtType] = useState('payable'); // 'payable' (Minh no) | 'receivable' (Nguoi ta no)
            const [isEditingDebt, setIsEditingDebt] = useState(null);
            const [showDebtForm, setShowDebtForm] = useState(false);
            const [activeDebtTab, setActiveDebtTab] = useState('payable'); // Tab View for Debt list
            const [autoCreateTransaction, setAutoCreateTransaction] = useState(true); // New: Sync debt with wallet

            const dbRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const initData = () => {
                    const localIncomes = JSON.parse(localStorage.getItem('family_incomes') || '[]');
                    const localExpenses = JSON.parse(localStorage.getItem('family_expenses') || '[]');
                    const localFixed = JSON.parse(localStorage.getItem('family_fixed_template') || '[]');
                    const localFixedTracking = JSON.parse(localStorage.getItem('family_fixed_tracking') || '{}');
                    
                    let localCats = JSON.parse(localStorage.getItem('family_categories') || 'null');
                    if (!localCats) {
                        const oldCustom = JSON.parse(localStorage.getItem('family_custom_categories') || '[]');
                        localCats = [...DEFAULT_CATEGORIES, ...oldCustom];
                        localCats = [...new Set(localCats)];
                    }

                    const localDebts = JSON.parse(localStorage.getItem('family_debts') || '[]');
                    const migratedDebts = localDebts.map(d => ({...d, type: d.type || 'payable'}));

                    setIncomes(localIncomes);
                    setExpenses(localExpenses);
                    setFixedTemplate(localFixed);
                    setCategories(localCats);
                    setDebts(migratedDebts);
                    setFixedTracking(localFixedTracking);
                }

                if (firebaseConfigStr && familyCode) {
                    try {
                        const config = JSON.parse(firebaseConfigStr);
                        if (!firebase.apps.length) { firebase.initializeApp(config); }
                        const db = firebase.firestore();
                        dbRef.current = db;
                        setIsConnected(true);
                        setIsSyncing(true);
                        const unsubscribe = db.collection('families').doc(familyCode).onSnapshot((doc) => {
                            if (doc.exists) { 
                                const data = doc.data(); 
                                setIncomes(data.incomes || []); 
                                setExpenses(data.expenses || []); 
                                setFixedTemplate(data.fixedTemplate || []);
                                if (data.categories && Array.isArray(data.categories)) {
                                    setCategories(data.categories);
                                } else {
                                    const oldCustom = data.customCategories || [];
                                    const merged = [...new Set([...DEFAULT_CATEGORIES, ...oldCustom])];
                                    setCategories(merged);
                                }
                                const loadedDebts = data.debts || [];
                                const migratedDebts = loadedDebts.map(d => ({...d, type: d.type || 'payable'}));
                                setDebts(migratedDebts);
                                setFixedTracking(data.fixedTracking || {});
                            } else { 
                                initData();
                                const initialCats = JSON.parse(localStorage.getItem('family_categories') || JSON.stringify(DEFAULT_CATEGORIES));
                                db.collection('families').doc(familyCode).set({ 
                                    incomes: [], expenses: [], fixedTemplate: [], 
                                    categories: initialCats, debts: [], fixedTracking: {}
                                }); 
                            }
                            setIsSyncing(false);
                        }, (error) => { console.error(error); setIsConnected(false); });
                        return () => unsubscribe();
                    } catch (e) { console.error(e); setIsConnected(false); initData(); }
                } else {
                    initData();
                }
            }, [firebaseConfigStr, familyCode]);

            const saveData = (newIncomes, newExpenses, newFixed = fixedTemplate, newCats = categories, newDebts = debts, newTracking = fixedTracking) => {
                setIncomes(newIncomes); setExpenses(newExpenses); setFixedTemplate(newFixed); setCategories(newCats); setDebts(newDebts); setFixedTracking(newTracking);
                
                localStorage.setItem('family_incomes', JSON.stringify(newIncomes));
                localStorage.setItem('family_expenses', JSON.stringify(newExpenses));
                localStorage.setItem('family_fixed_template', JSON.stringify(newFixed));
                localStorage.setItem('family_categories', JSON.stringify(newCats));
                localStorage.setItem('family_debts', JSON.stringify(newDebts));
                localStorage.setItem('family_fixed_tracking', JSON.stringify(newTracking));

                if (isConnected && dbRef.current && familyCode) {
                    setIsSyncing(true);
                    dbRef.current.collection('families').doc(familyCode).set({ 
                        incomes: newIncomes, expenses: newExpenses, fixedTemplate: newFixed, 
                        categories: newCats, debts: newDebts, fixedTracking: newTracking
                    })
                    .then(() => setIsSyncing(false)).catch(() => setIsSyncing(false));
                }
            };

            const handleSaveConfig = () => { try { JSON.parse(firebaseConfigStr); if (!familyCode.trim()) throw new Error("Chưa nhập Mã Gia Đình"); localStorage.setItem('fb_config', firebaseConfigStr); localStorage.setItem('fb_family_code', familyCode); alert("Cấu hình hợp lệ! Đang tải lại..."); window.location.reload(); } catch (e) { alert("Lỗi cấu hình! " + e.message); } };
            const handleDisconnect = () => { if(confirm('Ngắt kết nối?')) { localStorage.removeItem('fb_config'); localStorage.removeItem('fb_family_code'); window.location.reload(); }};
            const availableFilterCategories = useMemo(() => { const historyCategories = expenses.map(e => e.category); return Array.from(new Set([...categories, ...historyCategories])).sort(); }, [expenses, categories]);
            const getFiscalRange = (date) => { const year = date.getFullYear(), month = date.getMonth(); const startDate = new Date(year, month, 0); startDate.setHours(0,0,0,0); const endDate = new Date(year, month, new Date(year, month + 1, 0).getDate() - 1); endDate.setHours(23,59,59,999); return { startDate, endDate }; };
            const { startDate, endDate } = useMemo(() => getFiscalRange(viewDate), [viewDate]);
            const { filteredIncomes, filteredExpenses } = useMemo(() => { const filter = (items, type) => items.filter(item => { const d = new Date(item.date); if (!(d >= startDate && d <= endDate)) return false; const searchLower = searchTerm.toLowerCase(); const itemText = (type === 'income' ? item.source : item.category).toLowerCase(); const itemNote = (item.note || '').toLowerCase(); const itemAmount = item.amount.toString(); return (searchTerm === '' || itemText.includes(searchLower) || itemNote.includes(searchLower) || itemAmount.includes(searchLower)) && (filterCategory === 'all' || (type === 'expense' && item.category === filterCategory) || (type === 'income' && filterCategory === 'income_type')); }); return { filteredIncomes: filter(incomes, 'income'), filteredExpenses: filter(expenses, 'expense') }; }, [incomes, expenses, startDate, endDate, searchTerm, filterCategory]);
            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN').format(amount);
            
            const getCombinedDate = (dateInput) => {
                const datePart = new Date(dateInput);
                const now = new Date();
                datePart.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
                return datePart.toISOString();
            };

            const formatDate = (date) => { if(!date) return ''; const d = new Date(date); return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`; };
            const formatTime = (date) => { if(!date) return ''; const d = new Date(date); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; };
            
            const handleAmountInput = (val, setter) => { const raw = val.replace(/\D/g,''); setter(raw === '' ? '' : Number(raw).toLocaleString('vi-VN')); };
            const parseAmount = (val) => val ? parseInt(val.replace(/\./g,''), 10) : 0;
            const openFixedConfig = () => { const currentMap = {}; fixedTemplate.forEach(item => currentMap[item.category] = item.amount); setTempFixedList(currentMap); setShowFixedConfig(true); };
            const handleFixedAmountChange = (cat, val) => { const raw = val.replace(/\D/g,''); const amt = raw === '' ? 0 : parseInt(raw, 10); setTempFixedList(prev => ({ ...prev, [cat]: amt })); };
            const saveFixedConfig = () => { const newTemplate = []; Object.entries(tempFixedList).forEach(([cat, amt]) => { if (amt > 0) newTemplate.push({ category: cat, amount: amt }); }); saveData(incomes, expenses, newTemplate); setShowFixedConfig(false); alert('Đã lưu cấu hình!'); };
            
            const getMonthlyPaidForCategory = (cat) => {
                const { startDate: start, endDate: end } = getFiscalRange(viewDate);
                return expenses
                    .filter(e => e.category === cat && new Date(e.date) >= start && new Date(e.date) <= end)
                    .reduce((sum, item) => sum + item.amount, 0);
            };

            const handleConfirmFixedItem = (item, confirmedAmount) => {
                if (!confirmedAmount || confirmedAmount <= 0) return;
                const noteText = `Khoản chi cố định${confirmedAmount < item.amount ? ' (Đóng một phần)' : ''}`;
                if (!confirm(`Xác nhận chi khoản "${item.category}" với số tiền ${formatCurrency(confirmedAmount)}đ?`)) return;
                const newExpense = { id: Date.now() + Math.random(), category: item.category, amount: confirmedAmount, date: new Date().toISOString(), note: noteText };
                const newExpenses = [newExpense, ...expenses];
                const trackingKey = `${viewDate.getFullYear()}-${viewDate.getMonth()}`;
                const currentTracking = fixedTracking[trackingKey] || [];
                const newTrackingList = currentTracking.includes(item.category) ? currentTracking : [...currentTracking, item.category];
                const newTrackingObj = { ...fixedTracking, [trackingKey]: newTrackingList };
                saveData(incomes, newExpenses, fixedTemplate, categories, debts, newTrackingObj);
                setFixedPaymentInputs(prev => ({...prev, [item.category]: ''}));
            };

            const handleRemoveFixedItem = (catToRemove) => {
                if(confirm(`Bạn có chắc muốn xóa "${catToRemove}" khỏi danh sách theo dõi cố định?\n(Dữ liệu chi tiêu cũ vẫn được giữ nguyên)`)) {
                    const newTemplate = fixedTemplate.filter(t => t.category !== catToRemove);
                    const newTemp = { ...tempFixedList };
                    delete newTemp[catToRemove];
                    setTempFixedList(newTemp);
                    saveData(incomes, expenses, newTemplate, categories, debts, fixedTracking);
                }
            };

            const handleAddIncome = () => { 
                const amt = parseAmount(incomeAmount); 
                if(!incomeSource || amt <= 0) return; 
                
                const newItem = { 
                    id: editingId || Date.now(), 
                    source: incomeSource, 
                    amount: amt, 
                    date: getCombinedDate(incomeDate), 
                    note: incomeNote,
                }; 
                
                const newIncomes = editingId && editingType === 'income' ? incomes.map(i => i.id === editingId ? newItem : i) : [newItem, ...incomes]; 
                
                saveData(newIncomes, expenses, fixedTemplate, categories, debts); 
                if(editingId) alert('Đã cập nhật!'); 
                resetForm(); 
            };
            
            const handleAddExpense = () => { 
                const amt = parseAmount(expenseAmount); 
                if(!expenseCategory || amt <= 0) return; 
                let updatedDebts = debts;
                let finalNote = expenseNote;
                let linkedDebtId = null;
                let actionType = null;
                
                if (expenseCategory === DEBT_CATEGORY_NAME) {
                    if (!selectedDebtorId) { alert("Vui lòng chọn người liên quan!"); return; }
                    const debtItem = debts.find(d => d.id === Number(selectedDebtorId));
                    if (debtItem) {
                        linkedDebtId = debtItem.id;
                        if (debtItem.type === 'receivable') {
                            // Người ta nợ mình -> Mình chi thêm -> Cho vay thêm -> Tăng Total
                            const newTotal = debtItem.total + amt;
                            const updatedDebtItem = { ...debtItem, total: newTotal, updatedAt: new Date().toISOString() };
                            updatedDebts = debts.map(d => d.id === debtItem.id ? updatedDebtItem : d);
                            finalNote = `Cho vay thêm: ${debtItem.name} ${expenseNote ? '- ' + expenseNote : ''}`;
                            actionType = 'lend';
                        } else {
                            // Mình nợ người ta -> Mình chi -> Trả nợ -> Tăng Paid
                            const newPaid = debtItem.paid + amt;
                            const updatedDebtItem = { ...debtItem, paid: newPaid, updatedAt: new Date().toISOString() };
                            updatedDebts = debts.map(d => d.id === debtItem.id ? updatedDebtItem : d);
                            finalNote = `Trả nợ: ${debtItem.name} ${expenseNote ? '- ' + expenseNote : ''}`;
                            actionType = 'repay';
                        }
                    }
                }
                const newItem = { 
                    id: editingId || Date.now(), 
                    category: expenseCategory, 
                    amount: amt, 
                    date: getCombinedDate(expenseDate), 
                    note: finalNote,
                    relatedDebtId: linkedDebtId,
                    debtAction: actionType
                }; 
                const newExpenses = editingId && editingType === 'expense' ? expenses.map(e => e.id === editingId ? newItem : e) : [newItem, ...expenses]; 
                saveData(incomes, newExpenses, fixedTemplate, categories, updatedDebts); 
                if(editingId) alert('Đã cập nhật!'); 
                if (expenseCategory === DEBT_CATEGORY_NAME && !editingId) alert(`Đã lưu chi tiêu và cập nhật sổ nợ!`);
                resetForm(); 
            };
            
            const resetForm = () => { 
                setIncomeSource(''); setIncomeAmount(''); setIncomeNote('');
                setEditingId(null); setEditingType(null); 
                setExpenseCategory(''); setExpenseAmount(''); setExpenseNote('');
                setSelectedDebtorId('');
            };

            const handleEdit = (item, type) => { setEditingId(item.id); setEditingType(type); setActiveTab('add'); if (type === 'income') { setIncomeSource(item.source); setIncomeAmount(Number(item.amount).toLocaleString('vi-VN')); setIncomeDate(item.date.split('T')[0]); setIncomeNote(item.note || ''); } else { setExpenseCategory(item.category); setExpenseAmount(Number(item.amount).toLocaleString('vi-VN')); setExpenseDate(item.date.split('T')[0]); setExpenseNote(item.note || ''); } };
            
            const deleteItem = (id, type) => { 
                if(confirm('Bạn có chắc muốn xóa? Nếu khoản này liên quan đến Nợ, sổ nợ sẽ được hoàn tác lại.')) { 
                    let updatedDebts = debts;
                    
                    const itemToDelete = type === 'income' ? incomes.find(i => i.id === id) : expenses.find(e => e.id === id);
                    if (itemToDelete && itemToDelete.relatedDebtId) {
                        const debtItem = debts.find(d => d.id === itemToDelete.relatedDebtId);
                        if (debtItem) {
                            if (itemToDelete.debtAction === 'collect') { // Xóa thu nợ -> Giảm Paid
                                updatedDebts = debts.map(d => d.id === debtItem.id ? { ...d, paid: d.paid - itemToDelete.amount } : d);
                            } else if (itemToDelete.debtAction === 'lend') { // Xóa cho vay -> Giảm Total
                                updatedDebts = debts.map(d => d.id === debtItem.id ? { ...d, total: d.total - itemToDelete.amount } : d);
                            } else if (itemToDelete.debtAction === 'repay') { // Xóa trả nợ -> Giảm Paid
                                updatedDebts = debts.map(d => d.id === debtItem.id ? { ...d, paid: d.paid - itemToDelete.amount } : d);
                            }
                        }
                    }

                    const newIncomes = type === 'income' ? incomes.filter(i => i.id !== id) : incomes; 
                    const newExpenses = type === 'expense' ? expenses.filter(e => e.id !== id) : expenses; 
                    saveData(newIncomes, newExpenses, fixedTemplate, categories, updatedDebts); 
                }
            };
            
            const handleAddCustomCategory = () => { const newCat = prompt("Nhập tên mục chi tiêu mới:"); if (newCat && newCat.trim()) { const trimmedCat = newCat.trim(); if (categories.includes(trimmedCat)) { alert("Mục này đã tồn tại!"); return; } saveData(incomes, expenses, fixedTemplate, [...categories, trimmedCat], debts); } };
            const handleEditCategory = (oldCat) => { const newCat = prompt("Sửa tên mục chi tiêu:", oldCat); if (newCat && newCat.trim() && newCat !== oldCat) { const trimmedNew = newCat.trim(); if (categories.includes(trimmedNew)) { alert("Tên mục bị trùng!"); return; } if(confirm(`Bạn có chắc muốn đổi tên "${oldCat}" thành "${trimmedNew}"?\n\nHệ thống sẽ cập nhật tên này trong toàn bộ lịch sử chi tiêu, các khoản cố định và dữ liệu theo dõi.`)) { const newCats = categories.map(c => c === oldCat ? trimmedNew : c); const newExpenses = expenses.map(e => e.category === oldCat ? { ...e, category: trimmedNew } : e); const newFixedTemplate = fixedTemplate.map(t => t.category === oldCat ? { ...t, category: trimmedNew } : t); const newFixedTracking = { ...fixedTracking }; Object.keys(newFixedTracking).forEach(key => { if (Array.isArray(newFixedTracking[key])) { newFixedTracking[key] = newFixedTracking[key].map(c => c === oldCat ? trimmedNew : c); } }); saveData(incomes, newExpenses, newFixedTemplate, newCats, debts, newFixedTracking); alert("Đã cập nhật tên danh mục thành công!"); } } };
            const handleDeleteCategory = (catToDelete) => { if(confirm(`Bạn có chắc muốn xóa mục "${catToDelete}"?`)) { const newCats = categories.filter(c => c !== catToDelete); saveData(incomes, expenses, fixedTemplate, newCats, debts); } };
            const handleExportExcel = () => { const data = [...incomes.map(i => ({ Loại: 'Thu', Mục: i.source, 'Số tiền': i.amount, Ngày: formatDate(i.date), 'Giờ': formatTime(i.date), 'Ghi chú': i.note || '' })), ...expenses.map(e => ({ Loại: 'Chi', Mục: e.category, 'Số tiền': e.amount, Ngày: formatDate(e.date), 'Giờ': formatTime(e.date), 'Ghi chú': e.note || '' }))]; const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ThuChi"); XLSX.writeFile(wb, `Sothuchi_${new Date().toISOString().slice(0,10)}.xlsx`); };
            const handleBackup = () => { const data = { incomes, expenses, fixedTemplate, categories, debts, fixedTracking, version: 7, backupDate: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Sothuchi_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const handleRestore = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = JSON.parse(event.target.result); if (data.incomes && data.expenses && confirm(`Khôi phục bản sao lưu?`)) { saveData(data.incomes, data.expenses, data.fixedTemplate || [], data.categories || DEFAULT_CATEGORIES, data.debts || [], data.fixedTracking || {}); alert('Thành công!'); } } catch (err) { alert('Lỗi file!'); } }; reader.readAsText(file); e.target.value = null; };
            
            const handleSaveDebt = () => {
                const total = parseAmount(debtTotal);
                const paid = parseAmount(debtPaid);
                if (!debtName || total <= 0) { alert("Vui lòng nhập tên và tổng số tiền nợ hợp lệ."); return; }
                
                let currentIncomes = incomes;
                let currentExpenses = expenses;
                
                // Logic tự động tạo giao dịch khi lưu Form nợ
                if (autoCreateTransaction) {
                    const originalDebt = isEditingDebt ? debts.find(d => d.id === isEditingDebt) : null;
                    const originalPaid = originalDebt ? originalDebt.paid : 0;
                    const originalTotal = originalDebt ? originalDebt.total : 0;

                    // 1. Logic cho "Người ta nợ mình" (Receivable)
                    if (debtType === 'receivable') {
                         // Nếu Tổng nợ tăng -> Tức là mình cho vay thêm -> Tạo Chi phí
                         if (total > originalTotal) {
                             const diff = total - originalTotal;
                             currentExpenses = [{
                                 id: Date.now(), category: DEBT_CATEGORY_NAME, amount: diff, date: new Date().toISOString(),
                                 note: `Cho vay thêm: ${debtName} (Tự động từ Sổ Nợ)`, relatedDebtId: isEditingDebt || Date.now(), debtAction: 'lend'
                             }, ...currentExpenses];
                         }
                         // Nếu Đã trả tăng -> Tức là họ trả mình -> Tạo Thu nhập
                         if (paid > originalPaid) {
                             const diff = paid - originalPaid;
                             currentIncomes = [{
                                 id: Date.now() + 1, source: `Thu nợ: ${debtName}`, amount: diff, date: new Date().toISOString(),
                                 note: `Thu nợ (Tự động từ Sổ Nợ)`, relatedDebtId: isEditingDebt || Date.now(), debtAction: 'collect'
                             }, ...currentIncomes];
                         }
                    } 
                    // 2. Logic cho "Mình nợ người ta" (Payable)
                    else {
                        // Nếu Đã trả tăng -> Tức là mình trả nợ -> Tạo Chi phí
                        if (paid > originalPaid) {
                            const diff = paid - originalPaid;
                            currentExpenses = [{
                                id: Date.now(), category: DEBT_CATEGORY_NAME, amount: diff, date: new Date().toISOString(),
                                note: `Trả nợ: ${debtName} (Tự động từ Sổ Nợ)`, relatedDebtId: isEditingDebt || Date.now(), debtAction: 'repay'
                             }, ...currentExpenses];
                        }
                    }
                }

                const newItem = { id: isEditingDebt || Date.now(), name: debtName, total: total, paid: paid, note: debtNote, type: debtType, updatedAt: new Date().toISOString() };
                let newDebts;
                if (isEditingDebt) { newDebts = debts.map(d => d.id === isEditingDebt ? newItem : d); } else { newDebts = [newItem, ...debts]; }
                
                saveData(currentIncomes, currentExpenses, fixedTemplate, categories, newDebts);
                setShowDebtForm(false); setIsEditingDebt(null); setDebtName(''); setDebtTotal(''); setDebtPaid(''); setDebtNote(''); setAutoCreateTransaction(true);
            };

            const handleEditDebt = (item) => { 
                setIsEditingDebt(item.id); 
                setDebtName(item.name); 
                setDebtTotal(Number(item.total).toLocaleString('vi-VN')); 
                setDebtPaid(Number(item.paid).toLocaleString('vi-VN')); 
                setDebtNote(item.note || ''); 
                setDebtType(item.type || 'payable');
                setShowDebtForm(true); 
                // Fix: Bật autoCreateTransaction để khi sửa số liệu sẽ cộng trừ vào tổng tiền
                setAutoCreateTransaction(true); 
            };
            const handleDeleteDebt = (id) => { if (confirm("Xóa bản ghi nợ này?")) { const newDebts = debts.filter(d => d.id !== id); saveData(incomes, expenses, fixedTemplate, categories, newDebts); } };

            const resetMonthlyTracking = () => { if(confirm("Xóa dữ liệu theo dõi của tháng này? (Các khoản đã chi trong Lịch sử vẫn giữ nguyên, chỉ reset trạng thái đóng tiền ở đây).")) { const trackingKey = `${viewDate.getFullYear()}-${viewDate.getMonth()}`; const newTracking = { ...fixedTracking }; delete newTracking[trackingKey]; saveData(incomes, expenses, fixedTemplate, categories, debts, newTracking); } };

            useEffect(() => {
                if (!expenseCategory) { setCategorySpent(0); return; }
                const currentMonthExpenses = expenses.filter(e => {
                    if (e.category !== expenseCategory) return false;
                    const d = new Date(e.date);
                    return d >= startDate && d <= endDate;
                });
                const total = currentMonthExpenses.reduce((sum, item) => sum + item.amount, 0);
                setCategorySpent(total);
            }, [expenseCategory, expenses, startDate, endDate]);

            const savingsBreakdown = useMemo(() => { const result = {}; SAVING_CATEGORIES.forEach(cat => result[cat] = 0); expenses.forEach(e => { if (SAVING_CATEGORIES.includes(e.category)) { result[e.category] = (result[e.category] || 0) + e.amount; } }); return result; }, [expenses]);
            const totalSavings = Object.values(savingsBreakdown).reduce((a,b) => a+b, 0);
            const savingsHistory = useMemo(() => expenses.filter(e => SAVING_CATEGORIES.includes(e.category)).sort((a, b) => new Date(b.date) - new Date(a.date)), [expenses]);

            const sumIncomeMonth = incomes.filter(i => { const d = new Date(i.date); return d >= startDate && d <= endDate; }).reduce((a,c)=>a+c.amount,0);
            const sumExpenseMonth = expenses.filter(i => { const d = new Date(i.date); return d >= startDate && d <= endDate; }).reduce((a,c)=>a+c.amount,0);
            const balance = sumIncomeMonth - sumExpenseMonth;
            const isOverBudget = sumIncomeMonth > 0 && (sumExpenseMonth / sumIncomeMonth) > 0.9;

            return (
                <div className="min-h-screen pb-24 md:pb-0 relative font-sans">
                    <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative">
                        {isOverBudget && <div className="bg-red-50 text-red-600 px-4 py-2 text-xs font-bold flex items-center justify-center gap-2 animate-pulse-red border-b border-red-100"><AlertTriangle size={16} /> CẢNH BÁO: Đã chi tiêu quá 90% thu nhập!</div>}
                        
                        <div className={`bg-gradient-to-r ${isConnected ? 'from-blue-800 to-indigo-900' : 'from-slate-700 to-gray-800'} p-6 pb-8 text-white rounded-b-3xl shadow-lg transition-colors duration-500`}>
                            <div className="flex items-center justify-between mb-4">
                                <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 15))} className="p-2 text-white/70 hover:text-white btn-effect transition-all"><ChevronLeft size={24}/></button>
                                <div className="text-center">
                                    <span className="text-[10px] font-medium text-white/60 block mb-0.5 tracking-wider">{formatDate(startDate)} - {formatDate(endDate)}</span>
                                    <div className="font-bold text-xl text-white flex items-center gap-2 justify-center uppercase tracking-wide"><CalendarIcon size={18} className="text-blue-200"/> Tháng {viewDate.getMonth() + 1}/{viewDate.getFullYear()}</div>
                                </div>
                                <button onClick={()=>setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 15))} className="p-2 text-white/70 hover:text-white btn-effect transition-all"><ChevronRight size={24}/></button>
                            </div>
                            <div className="grid grid-cols-2 gap-4 mt-2">
                                <div className="bg-green-500/20 backdrop-blur-sm p-4 rounded-2xl border border-green-500/30"><div className="flex items-center gap-1.5 text-green-300 text-xs font-bold uppercase mb-1"><TrendingUp size={14}/> Tổng thu</div><div className="font-bold text-lg text-green-50">{formatCurrency(sumIncomeMonth)} VNĐ</div></div>
                                <div className="bg-red-500/20 backdrop-blur-sm p-4 rounded-2xl border border-red-500/30"><div className="flex items-center gap-1.5 text-red-300 text-xs font-bold uppercase mb-1"><TrendingDown size={14}/> Tổng chi</div><div className="font-bold text-lg text-red-50">{formatCurrency(sumExpenseMonth)} VNĐ</div></div>
                            </div>
                        </div>

                        <div className="px-4 -mt-6 relative z-10">
                            <div className="bg-white rounded-xl shadow-xl p-1.5 flex border border-gray-100 overflow-x-auto no-scrollbar">
                                {['add', 'debt', 'report', 'savings', 'history', 'settings'].map(tab => (
                                    <button 
                                        key={tab} 
                                        onClick={()=>{
                                            setActiveTab(tab); 
                                            resetForm();
                                            if (tab === 'history') { setFilterCategory('all'); setSearchTerm(''); }
                                        }} 
                                        className={`flex-1 min-w-[60px] py-2.5 rounded-lg text-[10px] font-bold uppercase tracking-wide transition-all btn-effect flex justify-center flex-col items-center gap-1 ${activeTab === tab ? 'bg-slate-800 text-white shadow-md' : 'text-gray-400 hover:bg-gray-50'}`}
                                    >
                                        {tab === 'add' ? 'Nhập' : tab === 'debt' ? 'Sổ Nợ' : tab === 'report' ? 'Báo Cáo' : tab === 'savings' ? 'Heo Đất' : tab === 'history' ? 'Lịch Sử' : <Settings size={16}/>}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-4 pb-32 safe-pb">
                            {activeTab === 'add' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                    <div className={`bg-white border border-green-100 rounded-2xl p-4 shadow-sm relative overflow-hidden ${editingId && editingType === 'expense' ? 'opacity-50 pointer-events-none' : ''}`}>
                                        <div className="absolute top-0 left-0 w-1.5 h-full bg-green-500"></div><div className="flex items-center gap-2 text-green-700 font-bold mb-3"><TrendingUp size={18}/> 1. Thu Nhập</div>
                                        <div className="space-y-3 pl-2">
                                            {/* Phần chọn thu nợ đã bị xóa theo yêu cầu */}
                                            <input type="text" placeholder="Nguồn thu (Lương, thưởng...)" value={incomeSource} onChange={e=>setIncomeSource(e.target.value)} className="w-full p-3 bg-gray-50 border-none rounded-xl font-medium input-effect transition-all duration-200"/>
                                            <input type="text" placeholder="Ghi chú (Tùy chọn)" value={incomeNote} onChange={e=>setIncomeNote(e.target.value)} className="w-full p-3 bg-gray-50 border-none rounded-xl text-sm italic text-gray-600 input-effect transition-all duration-200"/>
                                            <div className="flex gap-3">
                                                <input type="text" inputMode="numeric" placeholder="0" value={incomeAmount} onChange={e=>handleAmountInput(e.target.value, setIncomeAmount)} className="w-1/2 p-3 bg-gray-50 border-none rounded-xl font-bold text-gray-700 text-lg h-12 input-effect transition-all duration-200"/>
                                                <CustomDatePicker value={incomeDate} onChange={e=>setIncomeDate(e.target.value)} className="flex-1" />
                                            </div>
                                            <button onClick={handleAddIncome} disabled={!incomeSource || !incomeAmount} className="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-200 flex justify-center items-center gap-2 btn-effect transition-all duration-200">{editingId && editingType === 'income' ? 'Cập Nhật' : <><Plus size={18}/> Thêm</>}</button>
                                        </div>
                                    </div>
                                    
                                    <div className={`bg-white border border-red-100 rounded-2xl p-4 shadow-sm relative overflow-hidden ${editingId && editingType === 'income' ? 'opacity-50 pointer-events-none' : ''}`}>
                                        <div className="absolute top-0 left-0 w-1.5 h-full bg-red-500"></div>
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="flex items-center gap-2 text-red-700 font-bold"><TrendingDown size={18}/> 2. Chi Tiêu</div>
                                            <button onClick={() => setIsCategoryManageMode(!isCategoryManageMode)} className={`text-[10px] font-bold px-2 py-1 rounded border flex items-center gap-1 transition-colors btn-effect ${isCategoryManageMode ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-gray-100 text-gray-500 border-gray-200'}`}><Settings size={12}/> {isCategoryManageMode ? 'Xong' : 'Sửa Mục'}</button>
                                        </div>
                                        
                                        <div className="space-y-4 pl-2">
                                            <div>
                                                <label className="text-xs text-gray-400 font-bold uppercase mb-2 block">{isCategoryManageMode ? 'Chọn mục để Sửa/Xóa:' : 'Chọn mục chi:'}</label>
                                                <div className="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto pr-1">
                                                    {categories.map(cat => (
                                                        <button key={cat} onClick={() => isCategoryManageMode ? handleEditCategory(cat) : setExpenseCategory(cat)} className={`category-btn p-1 text-[10px] font-bold rounded-lg border transition-all relative btn-effect ${isCategoryManageMode ? 'bg-orange-50 border-orange-200 text-orange-700 hover:bg-orange-100' : expenseCategory === cat ? 'bg-red-600 text-white border-red-600 shadow-md ring-2 ring-red-100' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>{cat}{isCategoryManageMode && <span onClick={(e) => { e.stopPropagation(); handleDeleteCategory(cat); }} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[8px] border border-white z-10">X</span>}</button>
                                                    ))}
                                                    <button onClick={handleAddCustomCategory} className="category-btn p-1 text-[10px] font-bold rounded-lg border border-dashed border-gray-400 text-gray-500 hover:bg-gray-50 flex items-center justify-center btn-effect"><Plus size={16}/></button>
                                                </div>
                                            </div>
                                            
                                            {expenseCategory === DEBT_CATEGORY_NAME && (
                                                <div className="bg-blue-50 border border-blue-200 p-3 rounded-xl animate-fadeIn">
                                                    <label className="text-[10px] font-bold text-blue-700 uppercase mb-1 block">Chọn người liên quan:</label>
                                                    <select 
                                                        value={selectedDebtorId} 
                                                        onChange={(e) => setSelectedDebtorId(e.target.value)} 
                                                        className="w-full p-2 bg-white border border-blue-300 rounded-lg text-sm font-bold text-gray-700 outline-none"
                                                    >
                                                        <option value="">-- Chọn Sổ Nợ --</option>
                                                        
                                                        {/* 1. Render danh sách Mình nợ (Phải trả) */}
                                                        {debts.filter(d => d.type === 'payable' && (d.total - d.paid) > 0).map(d => (
                                                            <option key={d.id} value={d.id}>
                                                                Trả: {d.name} (Còn: {formatCurrency(d.total - d.paid)})
                                                            </option>
                                                        ))}

                                                        {/* 2. Dòng ngăn cách nhẹ (nếu có cả 2 loại nợ) */}
                                                        {debts.some(d => d.type === 'payable' && (d.total - d.paid) > 0) && 
                                                         debts.some(d => d.type === 'receivable') && (
                                                            <option disabled>─────────────</option>
                                                        )}

                                                        {/* 3. Render danh sách Họ nợ (Cho vay thêm) */}
                                                        {debts.filter(d => d.type === 'receivable').map(d => (
                                                            <option key={d.id} value={d.id}>
                                                                Cho vay thêm: {d.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}

                                            <input type="text" placeholder={expenseCategory === DEBT_CATEGORY_NAME ? "Ghi chú (VD: CK Vietcombank...)" : "Ghi chú (Phở bò, Cafe...)"} value={expenseNote} onChange={e=>setExpenseNote(e.target.value)} className="w-full p-3 bg-gray-50 border-none rounded-xl text-sm italic text-gray-600 input-effect transition-all duration-200" disabled={isCategoryManageMode}/>
                                            
                                            <div className="flex gap-3 pt-2 border-t border-gray-100">
                                                <input type="text" inputMode="numeric" placeholder="Số tiền..." value={expenseAmount} onChange={e=>handleAmountInput(e.target.value, setExpenseAmount)} className="w-1/2 p-3 bg-gray-50 border-none rounded-xl font-bold text-gray-700 text-lg h-12 input-effect transition-all duration-200" disabled={isCategoryManageMode}/>
                                                <CustomDatePicker value={expenseDate} onChange={e=>setExpenseDate(e.target.value)} className="flex-1" />
                                            </div>
                                            <button onClick={handleAddExpense} disabled={!expenseCategory || !expenseAmount || isCategoryManageMode || (expenseCategory===DEBT_CATEGORY_NAME && !selectedDebtorId)} className={`w-full py-3 font-bold rounded-xl shadow-lg flex justify-center items-center gap-2 btn-effect transition-all duration-200 ${isCategoryManageMode ? 'bg-gray-300 text-gray-500' : 'bg-red-600 text-white shadow-red-200'}`}>{editingId && editingType === 'expense' ? 'Cập Nhật' : <><Save size={18}/> Lưu Chi</>}</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'debt' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                     {!showDebtForm ? (
                                        <>
                                            <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 text-center">
                                                <div className="flex justify-between items-center mb-4">
                                                    <h3 className="font-bold text-gray-800 flex items-center gap-2"><Users className="text-blue-600" size={20}/> Quản Lý Nợ</h3>
                                                    <button onClick={() => { setShowDebtForm(true); setIsEditingDebt(null); setDebtName(''); setDebtTotal(''); setDebtPaid(''); setDebtNote(''); setAutoCreateTransaction(true); }} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-md hover:bg-blue-700 flex items-center gap-1 btn-effect"><Plus size={14}/> Thêm mới</button>
                                                </div>
                                                
                                                {/* Tab chọn loại nợ */}
                                                <div className="flex p-1 bg-gray-100 rounded-xl mb-4">
                                                    <button onClick={()=>setActiveDebtTab('payable')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${activeDebtTab==='payable' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500'}`}>Mình nợ (Phải trả)</button>
                                                    <button onClick={()=>setActiveDebtTab('receivable')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${activeDebtTab==='receivable' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500'}`}>Người ta nợ (Phải thu)</button>
                                                </div>

                                                <div className="grid grid-cols-2 gap-3 text-left">
                                                    <div className="bg-orange-50 p-3 rounded-xl border border-orange-100">
                                                        <div className="text-[10px] text-orange-500 font-bold uppercase">{activeDebtTab==='payable' ? 'Tổng nợ gốc' : 'Tổng cho vay'}</div>
                                                        <div className="font-bold text-lg text-orange-800">{formatCurrency(debts.filter(d => (d.type||'payable') === activeDebtTab).reduce((a,c) => a + c.total, 0))} đ</div>
                                                    </div>
                                                    <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                                        <div className="text-[10px] text-blue-500 font-bold uppercase">{activeDebtTab==='payable' ? 'Đã trả' : 'Đã thu hồi'}</div>
                                                        <div className="font-bold text-lg text-blue-800">{formatCurrency(debts.filter(d => (d.type||'payable') === activeDebtTab).reduce((a,c) => a + c.paid, 0))} đ</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="space-y-3">
                                                {debts.filter(d => (d.type || 'payable') === activeDebtTab).length === 0 ? <div className="text-center py-10 text-gray-400 text-sm">Danh sách trống.</div> :
                                                [...debts]
                                                    .filter(d => (d.type || 'payable') === activeDebtTab)
                                                    .sort((a,b) => (b.total - b.paid) - (a.total - a.paid))
                                                    .map(item => {
                                                    const remaining = item.total - item.paid;
                                                    const progress = item.total > 0 ? (item.paid / item.total) * 100 : 0;
                                                    return (
                                                        <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative group overflow-hidden">
                                                            <div className={`absolute top-0 left-0 w-1.5 h-full ${remaining <= 0 ? 'bg-green-500' : (activeDebtTab==='payable'?'bg-orange-500':'bg-blue-500')}`}></div>
                                                            <div className="pl-3">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <div>
                                                                        <h4 className="font-bold text-gray-800 text-base">{item.name}</h4>
                                                                        <p className="text-[10px] text-gray-400 italic">{item.note}</p>
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        <button onClick={() => handleEditDebt(item)} className="p-1.5 bg-gray-100 rounded text-blue-600 hover:bg-blue-50 btn-effect"><Edit2 size={14}/></button>
                                                                        <button onClick={() => handleDeleteDebt(item.id)} className="p-1.5 bg-gray-100 rounded text-red-600 hover:bg-red-50 btn-effect"><Trash2 size={14}/></button>
                                                                    </div>
                                                                </div>
                                                                <div className="flex justify-between text-xs mb-1 text-gray-500">
                                                                    <span>Tổng: {formatCurrency(item.total)}</span>
                                                                    <span>{activeDebtTab==='payable'?'Đã trả':'Đã thu'}: {formatCurrency(item.paid)}</span>
                                                                </div>
                                                                <div className="w-full bg-gray-100 rounded-full h-2 mb-2">
                                                                    <div className={`h-2 rounded-full ${remaining <= 0 ? 'bg-green-500' : (activeDebtTab==='payable'?'bg-orange-500':'bg-blue-500')}`} style={{width: `${progress}%`}}></div>
                                                                </div>
                                                                <div className="flex justify-between items-end">
                                                                    <span className="text-[10px] font-bold uppercase text-gray-400">Còn lại</span>
                                                                    <span className={`font-bold text-lg ${remaining <= 0 ? 'text-green-600' : 'text-gray-800'}`}>
                                                                        {remaining <= 0 ? 'Hoàn Thành' : formatCurrency(remaining) + ' VNĐ'}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </>
                                     ) : (
                                         <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 animate-fadeIn">
                                             <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm uppercase">{isEditingDebt ? 'Cập nhật khoản nợ' : 'Thêm khoản nợ mới'}</h3>
                                             
                                             {!isEditingDebt && (
                                                 <div className="mb-4">
                                                     <label className="text-[10px] font-bold text-gray-500 block mb-2">Loại nợ</label>
                                                     <div className="flex gap-2">
                                                         <button onClick={()=>setDebtType('payable')} className={`flex-1 py-2 text-xs font-bold rounded border ${debtType==='payable'?'bg-orange-100 text-orange-700 border-orange-300':'bg-white text-gray-500'}`}>Mình nợ (Trả)</button>
                                                         <button onClick={()=>setDebtType('receivable')} className={`flex-1 py-2 text-xs font-bold rounded border ${debtType==='receivable'?'bg-blue-100 text-blue-700 border-blue-300':'bg-white text-gray-500'}`}>Người ta nợ (Thu)</button>
                                                     </div>
                                                 </div>
                                             )}

                                             <div className="space-y-4">
                                                 <div><label className="text-[10px] font-bold text-gray-500">Tên người / Khoản nợ</label><input type="text" value={debtName} onChange={e=>setDebtName(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl font-bold text-gray-700 input-effect transition-all duration-200"/></div>
                                                 
                                                 <div className="p-3 bg-gray-50 rounded-xl border border-gray-200 space-y-3">
                                                     <div>
                                                         <label className="text-[10px] font-bold text-gray-500">Tổng tiền {debtType==='payable'?'(Nợ gốc)':'(Cho vay)'}</label>
                                                         <input type="text" inputMode="numeric" value={debtTotal} onChange={e=>handleAmountInput(e.target.value, setDebtTotal)} className="w-full p-2 bg-white border rounded-lg font-bold text-orange-600"/>
                                                         {debtType === 'receivable' && (
                                                             <div className="flex items-center gap-2 mt-1">
                                                                 <input type="checkbox" checked={autoCreateTransaction} onChange={e=>setAutoCreateTransaction(e.target.checked)} id="chkLend" className="w-3 h-3"/>
                                                                 <label htmlFor="chkLend" className="text-[10px] text-gray-600">Tạo khoản chi (Cho vay) nếu tăng?</label>
                                                             </div>
                                                         )}
                                                     </div>
                                                     <div>
                                                         <label className="text-[10px] font-bold text-gray-500">Số tiền {debtType==='payable'?'đã trả':'đã thu hồi'}</label>
                                                         <input type="text" inputMode="numeric" value={debtPaid} onChange={e=>handleAmountInput(e.target.value, setDebtPaid)} className="w-full p-2 bg-white border rounded-lg font-bold text-blue-600"/>
                                                         <div className="flex items-center gap-2 mt-1">
                                                             <input type="checkbox" checked={autoCreateTransaction} onChange={e=>setAutoCreateTransaction(e.target.checked)} id="chkPay" className="w-3 h-3"/>
                                                             <label htmlFor="chkPay" className="text-[10px] text-gray-600">
                                                                 {debtType==='payable' ? 'Tạo khoản chi (Trả nợ) nếu tăng?' : 'Tạo khoản thu (Thu nợ) nếu tăng?'}
                                                             </label>
                                                         </div>
                                                     </div>
                                                 </div>

                                                 <div><label className="text-[10px] font-bold text-gray-500">Ghi chú</label><textarea value={debtNote} onChange={e=>setDebtNote(e.target.value)} className="w-full p-3 bg-gray-50 border rounded-xl text-sm h-20 input-effect transition-all duration-200"></textarea></div>
                                                 
                                                 <div className="flex gap-3 pt-2">
                                                     <button onClick={()=>setShowDebtForm(false)} className="flex-1 py-3 bg-gray-200 text-gray-600 font-bold rounded-xl text-sm btn-effect">Hủy</button>
                                                     <button onClick={handleSaveDebt} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 text-sm btn-effect">Lưu & Đồng bộ</button>
                                                 </div>
                                             </div>
                                         </div>
                                     )}
                                </div>
                            )}

                            {activeTab === 'report' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                     <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                        <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 border-b pb-2"><PieChart className="text-slate-600" size={20}/> Tỷ lệ chi tiêu / Thu nhập</h3>
                                        {filteredExpenses.length === 0 ? <div className="text-center py-10 text-gray-400 text-sm">Chưa có dữ liệu kỳ này</div> : 
                                            <div className="space-y-5">
                                                {Object.entries(filteredExpenses.reduce((a,c)=>{a[c.category]=(a[c.category]||0)+c.amount;return a},{})).sort(([,a],[,b])=>b-a).map(([cat,amt]) => {
                                                    const pct = sumIncomeMonth > 0 ? Math.round((amt/sumIncomeMonth)*100) : 0;
                                                    return (
                                                        <div key={cat} className="group"><div className="flex justify-between text-sm mb-1.5"><span className="font-bold text-gray-700 flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-red-500"></div> {cat}</span><span className="text-gray-900 font-bold">{formatCurrency(amt)} VNĐ</span></div><div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden"><div className="bg-red-500 h-full rounded-full transition-all duration-1000" style={{width: `${Math.min(pct,100)}%`}}></div></div><div className="text-right mt-1 text-[10px] text-gray-400 font-medium">Chiếm {pct}% thu nhập</div></div>
                                                    )
                                                })}
                                            </div>
                                        }
                                    </div>
                                </div>
                            )}

                            {activeTab === 'savings' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center">
                                        <div className="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center text-pink-600 mx-auto mb-4"><PiggyBank size={32}/></div>
                                        <h3 className="text-sm text-gray-500 font-bold uppercase tracking-wider">Tổng Quỹ Tích Lũy</h3>
                                        <p className="text-4xl font-extrabold text-gray-800 mt-2">{formatCurrency(totalSavings)} VNĐ</p>
                                        <p className="text-xs text-gray-400 mt-2 italic">Tích lũy theo thời gian (Không reset theo tháng)</p>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        {SAVING_CATEGORIES.map((cat, idx) => (
                                            <div key={cat} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg ${idx===0?'bg-blue-500':idx===1?'bg-green-500':'bg-orange-500'}`}>{idx+1}</div>
                                                    <div>
                                                        <div className="font-bold text-gray-800 text-sm">{cat}</div>
                                                        <div className="text-[10px] text-gray-400">{idx===0 ? 'Mua Nhà/Đất' : idx===1 ? 'Mua sắm/Du lịch' : 'Ốm đau/Tai nạn'}</div>
                                                    </div>
                                                </div>
                                                <div className="font-bold text-gray-700">{formatCurrency(savingsBreakdown[cat])} đ</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                                        <div className="p-4 bg-gray-50 border-b border-gray-100">
                                            <h3 className="font-bold text-gray-700 text-sm flex items-center gap-2"><History size={16}/> Lịch sử nộp quỹ</h3>
                                        </div>
                                        <div className="max-h-[40vh] overflow-y-auto">
                                            {savingsHistory.length === 0 ? <div className="p-10 text-center text-gray-400 text-sm">Chưa có khoản tiết kiệm nào.</div> :
                                                savingsHistory.map((item) => (
                                                    <div key={item.id} className="p-4 flex justify-between items-center hover:bg-gray-50 border-b border-gray-50 last:border-0">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center text-pink-600"><TrendingUp size={18}/></div>
                                                            <div>
                                                                <p className="font-bold text-gray-800 text-sm">{item.category}</p>
                                                                <p className="text-xs text-gray-400 flex items-center gap-1 mt-0.5"><CalendarIcon size={10}/> {formatDate(item.date)}</p>
                                                            </div>
                                                        </div>
                                                        <span className="font-bold text-green-600 text-sm">+{formatCurrency(item.amount)}</span>
                                                    </div>
                                                ))
                                            }
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'history' && (
                                <div className="animate-fadeIn mt-2">
                                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[50vh]">
                                        <div className="p-4 bg-gray-50 border-b border-gray-100">
                                            <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-gray-700 text-sm flex items-center gap-2"><History size={16}/> Lịch sử & Tìm kiếm</h3><span className="text-[10px] bg-white border px-2 py-1 rounded text-gray-500 font-medium">{filteredIncomes.length + filteredExpenses.length} bản ghi</span></div>
                                            <div className="flex gap-2"><div className="relative flex-1"><Search size={14} className="absolute left-3 top-3 text-gray-400" /><input type="text" placeholder="Nhập Thu/Chi muốn tìm..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-3 py-2.5 bg-white border border-gray-200 rounded-xl text-xs font-medium focus:ring-2 focus:ring-blue-100 outline-none"/></div><select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)} className="pl-2 pr-6 py-2 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-600 outline-none truncate max-w-[100px]"><option value="all">Tất cả</option><option value="income_type">Thu nhập</option>{availableFilterCategories.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                        </div>
                                        <div className="max-h-[60vh] overflow-y-auto">
                                            {[...filteredIncomes.map(i=>({...i,type:'income'})), ...filteredExpenses.map(e=>({...e,type:'expense'}))]
                                                .sort((a,b) => {
                                                    const dateDiff = new Date(b.date) - new Date(a.date);
                                                    if (dateDiff !== 0) return dateDiff;
                                                    return b.id - a.id;
                                                })
                                                .map((item,idx) => (
                                                <div key={item.id} className={`p-4 flex justify-between items-center hover:bg-gray-50 transition-colors ${idx!==0?'border-t border-gray-50':''}`}>
                                                    <div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 shadow-sm ${item.type==='income'?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}`}>{item.type==='income'?<TrendingUp size={18}/>:<TrendingDown size={18}/>}</div><div><p className="font-bold text-gray-800 text-sm">{item.type==='income'?item.source:item.category}</p><p className="text-[10px] text-gray-500 italic">"{item.note || ''}"</p><p className="text-xs text-gray-400 flex items-center gap-2 mt-0.5"><span className="flex items-center gap-1"><CalendarIcon size={10}/> {formatDate(item.date)}</span> <span className="flex items-center gap-1 font-mono text-gray-500"><Clock size={10}/> {formatTime(item.date)}</span></p></div></div>
                                                    <div className="text-right"><p className={`font-bold text-sm ${item.type==='income'?'text-green-600':'text-red-600'}`}>{item.type==='income'?'+':'-'}{formatCurrency(item.amount)} VNĐ</p><div className="flex items-center justify-end gap-3 mt-1.5"><button onClick={()=>handleEdit(item, item.type)} className="text-[10px] text-gray-400 hover:text-blue-600 font-bold flex items-center gap-1"><Edit2 size={10}/> Sửa</button><button onClick={()=>deleteItem(item.id, item.type)} className="text-[10px] text-gray-400 hover:text-red-500 font-bold flex items-center gap-1"><Trash2 size={10}/> Xóa</button></div></div>
                                                </div>
                                            ))}
                                            {(filteredIncomes.length===0 && filteredExpenses.length===0) && <div className="p-10 text-center text-gray-400 text-sm">Không tìm thấy dữ liệu.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="space-y-6 animate-fadeIn mt-2">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                        <h3 className="font-bold text-gray-800 mb-6 flex items-center gap-2 border-b pb-2"><Settings className="text-slate-600" size={20}/> Cài đặt & Dữ liệu</h3>
                                        <div className="bg-purple-50 p-4 rounded-xl border border-purple-100"><div className="flex justify-between items-center mb-1"><h4 className="font-bold text-purple-800 text-sm flex items-center gap-2"><BookOpen size={16}/> 1. Các khoản chi cố định</h4><button onClick={openFixedConfig} className="text-purple-600 text-xs font-bold border border-purple-200 bg-white px-2 py-1 rounded btn-effect">Cấu hình mẫu</button></div><p className="text-xs text-purple-600 mb-3">Sử dụng bóng chat ở góc phải màn hình để xác nhận các khoản này hàng tháng.</p></div>
                                        <div className="bg-green-50 p-4 rounded-xl border border-green-100 mt-4"><h4 className="font-bold text-green-800 text-sm mb-1 flex items-center gap-2"><FileSpreadsheet size={16}/> 2. Xuất báo cáo Excel & Sao lưu</h4><div className="flex gap-2"><button onClick={handleExportExcel} className="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md flex justify-center items-center gap-2 text-xs btn-effect"><FileSpreadsheet size={16}/> Excel</button><button onClick={handleBackup} className="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md flex justify-center items-center gap-2 text-xs btn-effect"><Download size={16}/> Backup</button></div><div className="mt-3 pt-3 border-t border-green-200"><button onClick={() => fileInputRef.current.click()} className="w-full py-2 bg-white text-green-700 border border-green-300 font-bold rounded-lg flex justify-center items-center gap-2 text-xs hover:bg-green-50 btn-effect"><Upload size={14}/> Khôi phục từ file JSON</button><input type="file" ref={fileInputRef} onChange={handleRestore} className="hidden" accept=".json" /></div></div>
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mt-4"><div className="flex justify-between items-center mb-2"><h4 className="font-bold text-blue-800 text-sm flex items-center gap-2"><Cloud size={16}/> 3. Đồng bộ Đám mây (Online)</h4><button onClick={()=>setShowCloudForm(!showCloudForm)} className="text-blue-500 hover:text-blue-700 btn-effect"><ChevronDown size={16} className={`transform transition-transform ${showCloudForm ? 'rotate-180' : ''}`}/></button></div>{isConnected ? (<div className="space-y-3"><div className="bg-white p-3 rounded-lg border border-blue-200"><p className="text-xs text-gray-500 uppercase font-bold">Đang kết nối tới:</p><p className="text-sm font-bold text-blue-600 mt-1">{familyCode}</p></div><button onClick={handleDisconnect} className="w-full py-2 bg-white text-red-500 border border-red-200 font-bold rounded-lg text-xs hover:bg-red-50 btn-effect">Ngắt kết nối</button></div>) : (showCloudForm && (<div className="space-y-3 animate-fadeIn"><p className="text-xs text-blue-600 leading-relaxed">Nhập cấu hình Firebase và Mã gia đình để đồng bộ.</p><div><label className="text-[10px] font-bold text-gray-500 uppercase">Mã Gia Đình</label><input type="text" value={familyCode} onChange={e=>setFamilyCode(e.target.value)} className="w-full p-2 mt-1 border rounded-lg text-sm bg-white" placeholder="Ví dụ: GD-123456" /></div><div><label className="text-[10px] font-bold text-gray-500 uppercase">Cấu hình Firebase (JSON)</label><textarea value={firebaseConfigStr} onChange={e=>setFirebaseConfigStr(e.target.value)} className="w-full p-2 mt-1 border rounded-lg text-[10px] h-20 bg-white font-mono" placeholder='{"apiKey": "..."}'></textarea></div><button onClick={handleSaveConfig} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-all text-xs btn-effect">KẾT NỐI NGAY</button></div>))} {!isConnected && !showCloudForm && <button onClick={()=>setShowCloudForm(true)} className="w-full py-2 bg-white text-blue-600 border border-blue-300 font-bold rounded-lg text-xs mt-2 btn-effect">Thiết lập kết nối</button>}</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {showFixedConfig && (
                            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-fadeIn backdrop-blur-sm">
                                <div className="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
                                    <div className="p-4 bg-purple-50 border-b border-purple-100 flex justify-between items-center"><h3 className="font-bold text-purple-800 flex items-center gap-2">Cài đặt khoản cố định</h3><button onClick={()=>setShowFixedConfig(false)}><X size={20} className="text-purple-400"/></button></div>
                                    <div className="p-4 overflow-y-auto flex-1 space-y-3"><p className="text-xs text-gray-500 mb-2 italic">Nhập số tiền cho các mục cố định hàng tháng (Để trống nếu không có).</p>{categories.map(cat => (<div key={cat} className="flex items-center justify-between gap-2 border-b border-gray-50 pb-2"><span className="text-sm font-medium text-gray-700 flex-1">{cat}</span><input type="text" inputMode="numeric" placeholder="0" value={tempFixedList[cat] ? Number(tempFixedList[cat]).toLocaleString('vi-VN') : ''} onChange={(e) => handleFixedAmountChange(cat, e.target.value)} className="w-24 p-2 bg-gray-50 border border-gray-200 rounded text-right text-sm font-bold text-purple-700 focus:outline-none focus:ring-1 focus:ring-purple-500" /></div>))}</div>
                                    <div className="p-4 border-t border-gray-100"><button onClick={saveFixedConfig} className="w-full py-3 bg-purple-600 text-white font-bold rounded-xl shadow-lg hover:bg-purple-700 transition-all btn-effect">Lưu Cấu Hình</button></div>
                                </div>
                            </div>
                        )}

                        {showFixedTrackingModal && (
                            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-fadeIn backdrop-blur-sm">
                                <div className="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
                                    <div className="p-4 bg-purple-50 border-b border-purple-100 flex justify-between items-center">
                                        <h3 className="font-bold text-purple-800 flex items-center gap-2">Chi cố định tháng {viewDate.getMonth() + 1}</h3>
                                        <div className="flex gap-2">
                                            <button onClick={resetMonthlyTracking} className="text-red-400 hover:text-red-600 transition-colors"><Trash2 size={20}/></button>
                                            <button onClick={()=>setShowFixedTrackingModal(false)}><X size={20} className="text-purple-400"/></button>
                                        </div>
                                    </div>
                                    <div className="p-4 overflow-y-auto flex-1 space-y-4">
                                        {fixedTemplate.length === 0 && <p className="text-center text-sm text-gray-400 py-4">Chưa cài đặt mục cố định nào.</p>}
                                        {fixedTemplate.map(item => {
                                            const paidSoFar = getMonthlyPaidForCategory(item.category);
                                            const remaining = item.amount - paidSoFar;
                                            const isFullyPaid = remaining <= 0;
                                            const inputValue = fixedPaymentInputs[item.category] !== undefined ? fixedPaymentInputs[item.category] : (remaining > 0 ? formatCurrency(remaining) : '');
                                            return (
                                                <div key={item.category} className={`border-b border-gray-100 pb-3 ${isFullyPaid ? 'opacity-50' : ''}`}>
                                                    <div className="flex justify-between items-start mb-1">
                                                        <div className="flex items-start gap-2">
                                                            <button onClick={() => handleRemoveFixedItem(item.category)} className="mt-0.5 text-gray-300 hover:text-red-500 transition-colors btn-effect" title="Xóa khỏi danh sách cố định"><X size={14}/></button>
                                                            <div><span className="text-sm font-bold text-gray-800 block">{item.category}</span><span className="text-[10px] text-gray-400 italic">Kế hoạch: {formatCurrency(item.amount)}</span></div>
                                                        </div>
                                                        <div className="text-right"><span className={`text-xs font-bold block ${isFullyPaid ? 'text-green-600' : 'text-orange-500'}`}>{isFullyPaid ? 'Đã xong' : `Còn: ${formatCurrency(remaining)}`}</span><span className="text-[10px] text-blue-500">Đã trả: {formatCurrency(paidSoFar)}</span></div>
                                                    </div>
                                                    {!isFullyPaid && (<div className="flex gap-2 mt-2"><input type="text" inputMode="numeric" placeholder="Số tiền..." value={inputValue} onChange={(e) => { const val = e.target.value.replace(/\D/g,''); const formatted = val === '' ? '' : Number(val).toLocaleString('vi-VN'); setFixedPaymentInputs(prev => ({...prev, [item.category]: formatted})); }} className="flex-1 p-2 bg-gray-50 border border-gray-200 rounded text-sm font-bold text-gray-700 outline-none focus:border-purple-500 transition-colors" /><button onClick={() => { const amt = inputValue ? parseAmount(inputValue.toString()) : remaining; handleConfirmFixedItem(item, amt); }} className="px-4 py-2 bg-purple-600 text-white text-xs font-bold rounded shadow-md hover:bg-purple-700 btn-effect">Trả</button></div>)}
                                                    {isFullyPaid && <div className="mt-1 text-center bg-green-50 text-green-600 text-[10px] font-bold py-1 rounded">Hoàn tất chi tiêu</div>}
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        <div onClick={()=>setShowFixedTrackingModal(true)} className="fixed bottom-8 left-4 z-50 flex flex-col items-center gap-1 cursor-pointer group">
                             <div className="bg-purple-600 shadow-xl rounded-full p-3 border-2 border-white transform group-hover:scale-110 transition-all btn-effect">
                                <MessageCircle size={24} className="text-white"/>
                            </div>
                        </div>

                        <div onClick={()=>setShowReloadConfirm(true)} className={`fixed bottom-8 right-4 z-50 flex flex-col items-center gap-1 cursor-pointer transition-all duration-300 ${balance===0?'opacity-80':'opacity-100'}`}>
                            <div className={`shadow-2xl rounded-full px-5 py-3 flex items-center gap-3 border-2 border-white/20 backdrop-blur-lg transform hover:scale-105 btn-effect transition-all ${balance>=0?'bg-gradient-to-r from-blue-600 to-cyan-500':'bg-gradient-to-r from-red-600 to-orange-500'}`}>
                                <div className="bg-white/20 p-1.5 rounded-full"><Wallet size={20} className="text-white"/></div>
                                <div className="flex flex-col items-start"><span className="text-white font-extrabold text-lg leading-none">{formatCurrency(balance)} <span className="text-xs font-normal opacity-80">VNĐ</span></span></div>
                            </div>
                        </div>

                        {showReloadConfirm && (
                            <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-fadeIn backdrop-blur-sm">
                                <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-xs w-full text-center border border-gray-100">
                                    <div className="bg-slate-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600"><RefreshCw size={24} /></div>
                                    <h3 className="font-bold text-lg text-slate-800 mb-2">Tải lại ứng dụng?</h3>
                                    <div className="flex gap-3 mt-6"><button onClick={()=>setShowReloadConfirm(false)} className="flex-1 py-3 text-sm font-bold text-slate-500 bg-slate-100 rounded-xl btn-effect">Hủy</button><button onClick={()=>window.location.reload()} className="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl shadow-lg btn-effect">Đồng ý</button></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
